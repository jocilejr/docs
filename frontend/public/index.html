<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Baileys</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f7fa;
      }

      #baileys-dashboard {
        max-width: 960px;
        margin: 0 auto 48px auto;
        background: #ffffff;
        border: 1px solid #d9e2ec;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }

      #baileys-dashboard h2 {
        margin-top: 0;
        color: #1f2933;
      }

      .dashboard-description {
        color: #52606d;
        margin-bottom: 16px;
      }

      .panel-section {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e4e7eb;
      }

      .panel-section:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }

      .panel-section h3 {
        margin-top: 0;
        color: #243b53;
      }

      .form-grid {
        display: grid;
        gap: 16px;
      }

      @media (min-width: 720px) {
        .form-grid.two-columns {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      label {
        display: block;
        font-weight: 600;
        color: #243b53;
        margin-bottom: 6px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #cbd2d9;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 12px;
      }

      textarea {
        min-height: 80px;
        resize: vertical;
      }

      button {
        background-color: #2563eb;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
      }

      button:hover {
        background-color: #1d4ed8;
      }

      pre {
        background: #f8fafc;
        border: 1px solid #e4e7eb;
        border-radius: 4px;
        padding: 12px;
        overflow-x: auto;
        font-size: 13px;
        color: #1f2933;
      }

      .result-container {
        margin-top: 12px;
      }

      .error {
        color: #b91c1c;
      }

      .qr-preview {
        margin-top: 12px;
        text-align: center;
      }

      .qr-preview img {
        max-width: 240px;
        border: 1px solid #cbd2d9;
        border-radius: 8px;
        padding: 8px;
        background: #ffffff;
      }

      .inline-hint {
        font-size: 12px;
        color: #829ab1;
        margin-top: -8px;
        margin-bottom: 12px;
      }
    </style>
  </head>
  <body>
    <div id="baileys-dashboard">
      <h2>Painel interativo Baileys</h2>
      <p class="dashboard-description">
        Utilize o painel abaixo para acionar rapidamente as principais rotas da API. Informe o servidor desejado e o
        token Bearer para autenticação antes de enviar as requisições.
      </p>

      <div class="panel-section">
        <h3>Configurações gerais</h3>
        <div class="form-grid two-columns">
          <div>
            <label for="server-base">Servidor alvo (base URL)</label>
            <input
              id="server-base"
              name="server-base"
              placeholder="https://api.exemplo.com"
              type="url"
            />
            <p class="inline-hint">Deixe em branco para utilizar caminhos relativos ao mesmo domínio.</p>
          </div>
          <div>
            <label for="bearer-token">Token Bearer</label>
            <input
              id="bearer-token"
              name="bearer-token"
              placeholder="Bearer eyJhbGciOi..."
            />
            <p class="inline-hint">Se o token não possuir o prefixo <code>Bearer</code>, ele será adicionado automaticamente.</p>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <h3>Criar instância</h3>
        <form id="create-instance-form">
          <label for="instance-id">Identificador da instância</label>
          <input id="instance-id" name="instance-id" placeholder="instancia-01" required />

          <label for="instance-name">Nome (opcional)</label>
          <input id="instance-name" name="instance-name" placeholder="Instância principal" />

          <label for="instance-webhook">Webhook URL (opcional)</label>
          <input id="instance-webhook" name="instance-webhook" placeholder="https://exemplo.com/webhooks" />

          <button type="submit">Criar instância</button>
        </form>
        <div class="result-container">
          <pre id="create-instance-result">Aguardando envio...</pre>
        </div>
      </div>

      <div class="panel-section">
        <h3>Recuperar QR Code</h3>
        <form id="qr-code-form">
          <label for="qr-instance-id">Identificador da instância</label>
          <input id="qr-instance-id" name="qr-instance-id" placeholder="instancia-01" required />

          <button type="submit">Buscar QR Code</button>
        </form>
        <div class="result-container">
          <pre id="qr-code-result">Aguardando envio...</pre>
          <div class="qr-preview" id="qr-code-preview"></div>
        </div>
      </div>

      <div class="panel-section">
        <h3>Enviar mensagem</h3>
        <form id="send-message-form">
          <label for="message-instance-id">Identificador da instância</label>
          <input id="message-instance-id" name="message-instance-id" placeholder="instancia-01" required />

          <label for="message-to">Número do destinatário (DDD + número)</label>
          <input id="message-to" name="message-to" placeholder="5599999999999" required />

          <label for="message-type">Tipo de mensagem</label>
          <select id="message-type" name="message-type">
            <option value="text" selected>text</option>
            <option value="media">media</option>
            <option value="template">template</option>
          </select>

          <label for="message-payload">Payload da mensagem (JSON)</label>
          <textarea
            id="message-payload"
            name="message-payload"
            placeholder='{"text": "Olá, esta é uma mensagem automática."}'
            required
          ></textarea>
          <p class="inline-hint">Informe o objeto JSON conforme o tipo selecionado.</p>

          <button type="submit">Enviar mensagem</button>
        </form>
        <div class="result-container">
          <pre id="send-message-result">Aguardando envio...</pre>
        </div>
      </div>
    </div>
    <script>
      window.addEventListener('load', () => {
        initBaileysDashboard();
      });

      function initBaileysDashboard() {
        const serverInput = document.getElementById('server-base');
        const tokenInput = document.getElementById('bearer-token');
        const createForm = document.getElementById('create-instance-form');
        const createResult = document.getElementById('create-instance-result');
        const qrForm = document.getElementById('qr-code-form');
        const qrResult = document.getElementById('qr-code-result');
        const qrPreview = document.getElementById('qr-code-preview');
        const messageForm = document.getElementById('send-message-form');
        const messageResult = document.getElementById('send-message-result');

        try {
          const savedServer = localStorage.getItem('baileys-dashboard-server');
          if (savedServer) {
            serverInput.value = savedServer;
          }
          const savedToken = localStorage.getItem('baileys-dashboard-token');
          if (savedToken) {
            tokenInput.value = savedToken;
          }
        } catch (error) {
          console.warn('Não foi possível recuperar configurações salvas:', error);
        }

        const persistSettings = () => {
          try {
            localStorage.setItem('baileys-dashboard-server', serverInput.value.trim());
            localStorage.setItem('baileys-dashboard-token', tokenInput.value.trim());
          } catch (error) {
            console.warn('Não foi possível salvar configurações:', error);
          }
        };

        serverInput.addEventListener('change', persistSettings);
        tokenInput.addEventListener('change', persistSettings);

        const getSelectedServer = () => serverInput.value?.trim();

        const buildUrl = (path) => {
          const base = getSelectedServer() || '';
          const normalizedBase = base.endsWith('/') ? base.slice(0, -1) : base;
          if (!normalizedBase) {
            return path;
          }
          if (!path.startsWith('/')) {
            return `${normalizedBase}/${path}`;
          }
          return `${normalizedBase}${path}`;
        };

        const buildHeaders = (contentType = 'application/json') => {
          const headers = { Accept: 'application/json' };
          if (contentType) {
            headers['Content-Type'] = contentType;
          }
          const token = tokenInput.value.trim();
          if (token) {
            headers.Authorization = token.toLowerCase().startsWith('bearer ')
              ? token
              : `Bearer ${token}`;
            persistSettings();
          }
          return headers;
        };

        const renderResult = async (response, target) => {
          let text = '';
          try {
            text = await response.clone().text();
          } catch (error) {
            console.warn('Não foi possível ler a resposta como texto:', error);
          }

          let formatted = text;
          try {
            formatted = JSON.stringify(JSON.parse(text), null, 2);
            target.classList.remove('error');
          } catch (error) {
            if (!response.ok) {
              target.classList.add('error');
            } else {
              target.classList.remove('error');
            }
          }

          if (!response.ok) {
            target.classList.add('error');
          }

          target.textContent = formatted || '(sem conteúdo)';
          return text;
        };

        createForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          createResult.textContent = 'Enviando...';
          createResult.classList.remove('error');

          const id = document.getElementById('instance-id').value.trim();
          const name = document.getElementById('instance-name').value.trim();
          const webhook = document.getElementById('instance-webhook').value.trim();

          const payload = { id };
          if (name || webhook) {
            payload.metadata = {};
            if (name) payload.metadata.name = name;
            if (webhook) payload.metadata.webhookUrl = webhook;
          }

          try {
            const response = await fetch(buildUrl('/instances'), {
              method: 'POST',
              headers: buildHeaders(),
              body: JSON.stringify(payload),
            });
            await renderResult(response, createResult);
          } catch (error) {
            createResult.classList.add('error');
            createResult.textContent = `Erro ao enviar requisição: ${error.message}`;
          }
        });

        qrForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          qrResult.textContent = 'Buscando QR Code...';
          qrResult.classList.remove('error');
          qrPreview.innerHTML = '';

          const instanceId = document.getElementById('qr-instance-id').value.trim();
          const url = buildUrl(`/qrcode?instanceId=${encodeURIComponent(instanceId)}`);

          try {
            const response = await fetch(url, {
              method: 'GET',
              headers: buildHeaders(null),
            });
            const rawText = await renderResult(response, qrResult);

            if (response.ok) {
              let data = null;
              try {
                data = JSON.parse(rawText);
              } catch (error) {
                console.warn('Não foi possível interpretar a resposta de QR Code como JSON:', error);
              }
              if (data?.image?.type === 'base64' && data?.image?.value) {
                const image = document.createElement('img');
                image.alt = `QR Code da instância ${data.instanceId || instanceId}`;
                image.src = `data:image/png;base64,${data.image.value}`;
                qrPreview.innerHTML = '';
                qrPreview.appendChild(image);
              } else if (data?.image?.type === 'url' && data?.image?.value) {
                const link = document.createElement('a');
                link.href = data.image.value;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = 'Abrir QR Code hospedado';
                qrPreview.innerHTML = '';
                qrPreview.appendChild(link);
              }
            }
          } catch (error) {
            qrResult.classList.add('error');
            qrResult.textContent = `Erro ao buscar QR Code: ${error.message}`;
          }
        });

        messageForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          messageResult.textContent = 'Enviando mensagem...';
          messageResult.classList.remove('error');

          const instanceId = document.getElementById('message-instance-id').value.trim();
          const to = document.getElementById('message-to').value.trim();
          const type = document.getElementById('message-type').value;
          const rawPayload = document.getElementById('message-payload').value.trim();

          let messagePayload;
          try {
            messagePayload = rawPayload ? JSON.parse(rawPayload) : {};
          } catch (error) {
            messageResult.classList.add('error');
            messageResult.textContent = `Payload inválido: ${error.message}`;
            return;
          }

          const payload = {
            instanceId,
            to,
            type,
            message: messagePayload,
          };

          try {
            const response = await fetch(buildUrl('/messages'), {
              method: 'POST',
              headers: buildHeaders(),
              body: JSON.stringify(payload),
            });
            await renderResult(response, messageResult);
          } catch (error) {
            messageResult.classList.add('error');
            messageResult.textContent = `Erro ao enviar mensagem: ${error.message}`;
          }
        });
      }
    </script>
  </body>
</html>
