<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Baileys - Instâncias</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f7fb;
        --surface: #ffffff;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --border: #d9e2ec;
        --border-strong: #cbd2d9;
        --text: #1f2933;
        --muted: #52606d;
        --success: #047857;
        --warning: #f59e0b;
        --danger: #b91c1c;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      main {
        max-width: 960px;
        margin: 32px auto;
        padding: 0 20px 60px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 28px;
      }

      h2 {
        margin: 0 0 16px;
        font-size: 20px;
      }

      p {
        margin: 0;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      label {
        font-weight: 600;
        color: #243b53;
      }

      input,
      textarea {
        border: 1px solid var(--border-strong);
        border-radius: 6px;
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
        background: #fff;
      }

      input:focus,
      textarea:focus {
        outline: 2px solid rgba(37, 99, 235, 0.35);
        outline-offset: 2px;
      }

      button {
        align-self: flex-start;
        border: none;
        border-radius: 6px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        transition: background 0.2s ease;
      }

      button:hover {
        background: var(--primary-dark);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.65;
      }

      button.secondary {
        background: #334155;
      }

      button.secondary:hover {
        background: #1e293b;
      }

      button.danger {
        background: var(--danger);
      }

      button.danger:hover {
        background: #991b1b;
      }

      .hint {
        font-size: 13px;
        color: var(--muted);
      }

      .feedback {
        font-size: 14px;
        font-weight: 500;
      }

      .feedback.error {
        color: var(--danger);
      }

      .feedback.success {
        color: var(--success);
      }

      .section {
        margin-bottom: 32px;
      }

      .instances-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .instances-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .instance-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .instance-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: baseline;
        flex-wrap: wrap;
      }

      .instance-title {
        font-size: 18px;
        font-weight: 600;
      }

      .instance-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 13px;
        color: var(--muted);
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        background: #e4e7eb;
        color: #243b53;
      }

      .status-ready {
        background: rgba(4, 120, 87, 0.15);
        color: var(--success);
      }

      .status-pending_qr {
        background: rgba(245, 158, 11, 0.18);
        color: var(--warning);
      }

      .status-disconnected {
        background: rgba(185, 28, 28, 0.14);
        color: var(--danger);
      }

      .instance-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .qr-container,
      .endpoints-container {
        border-top: 1px solid var(--border);
        padding-top: 16px;
      }

      .qr-status {
        font-size: 14px;
        color: var(--muted);
        margin: 0 0 12px;
      }

      .qr-image {
        max-width: 220px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px;
        background: #fff;
      }

      .endpoints-grid {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .endpoint-card {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px;
        background: #f8fafc;
      }

      .endpoint-header {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .method-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.03em;
        text-transform: uppercase;
      }

      .method-get {
        background: rgba(16, 185, 129, 0.16);
        color: #047857;
      }

      .method-post {
        background: rgba(37, 99, 235, 0.18);
        color: var(--primary);
      }

      .method-delete {
        background: rgba(185, 28, 28, 0.16);
        color: var(--danger);
      }

      .method-patch {
        background: rgba(234, 179, 8, 0.18);
        color: var(--warning);
      }

      code,
      pre {
        font-family: "Fira Code", "Source Code Pro", monospace;
        font-size: 13px;
      }

      code {
        background: #e4e7eb;
        padding: 4px 6px;
        border-radius: 4px;
      }

      pre {
        margin: 10px 0 0;
        padding: 12px;
        border-radius: 6px;
        background: #111827;
        color: #e5e7eb;
        overflow-x: auto;
      }

      .empty-state {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        color: var(--muted);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 640px) {
        main {
          margin: 24px auto;
          padding: 0 14px 40px;
        }

        .card {
          padding: 18px;
        }

        .instance-card {
          padding: 16px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
  </head>
  <body>
    <main class="stack">
      <header>
        <h1>Painel de Instâncias Baileys</h1>
        <p class="hint">
          Conecte números via QR Code, monitore o status das instâncias e copie os endpoints prontos para uso em outros
          sistemas.
        </p>
      </header>

      <section class="card section" aria-labelledby="configuracoes-gerais">
        <div class="stack">
          <h2 id="configuracoes-gerais">Configurações gerais</h2>
          <div class="stack">
            <div class="field">
              <label for="server-base">Servidor (base URL)</label>
              <input id="server-base" name="server-base" placeholder="https://api.exemplo.com" type="url" />
              <p class="hint">Deixe em branco para usar o mesmo host do painel.</p>
            </div>
            <div class="field">
              <label for="bearer-token">Token Bearer</label>
              <input id="bearer-token" name="bearer-token" placeholder="Bearer eyJhbGciOi..." />
              <p class="hint">O prefixo <code>Bearer</code> será aplicado automaticamente se necessário.</p>
            </div>
          </div>
        </div>
      </section>

      <section class="card section" aria-labelledby="nova-instancia">
        <div class="stack">
          <h2 id="nova-instancia">Nova instância</h2>
          <form id="create-instance-form" class="stack">
            <div class="field">
              <label for="instance-id">Identificador</label>
              <input id="instance-id" name="instance-id" placeholder="campanha-01" required />
            </div>
            <div class="field">
              <label for="campaign-name">Nome da campanha (opcional)</label>
              <input id="campaign-name" name="campaign-name" placeholder="Campanha principal" />
              <p class="hint">Use este nome para identificar o cartão após a conexão.</p>
            </div>
            <button type="submit">Criar instância</button>
            <p id="form-feedback" class="feedback"></p>
          </form>
        </div>
      </section>

      <section class="card section" aria-labelledby="lista-instancias">
        <div class="stack">
          <div class="instances-header">
            <h2 id="lista-instancias">Instâncias cadastradas</h2>
            <button type="button" id="refresh-button" class="secondary">Atualizar lista</button>
          </div>
          <p id="instances-feedback" class="feedback"></p>
          <div id="instances-empty" class="empty-state hidden">
            Nenhuma instância cadastrada ainda. Crie uma nova instância para gerar o QR Code e iniciar a autenticação.
          </div>
          <div id="instance-list" class="instances-list"></div>
        </div>
      </section>
    </main>

    <script>
      (() => {
        const serverInput = document.getElementById('server-base');
        const tokenInput = document.getElementById('bearer-token');
        const form = document.getElementById('create-instance-form');
        const formFeedback = document.getElementById('form-feedback');
        const refreshButton = document.getElementById('refresh-button');
        const instanceList = document.getElementById('instance-list');
        const instancesFeedback = document.getElementById('instances-feedback');
        const emptyState = document.getElementById('instances-empty');
        const instanceIdInput = document.getElementById('instance-id');
        const campaignInput = document.getElementById('campaign-name');

        const STATUS_LABELS = {
          ready: 'Conectada',
          pending_qr: 'Aguardando QR Code',
          disconnected: 'Desconectada',
        };

        const state = {
          instances: [],
          polling: new Map(),
        };

        function loadSettings() {
          try {
            const savedBase = localStorage.getItem('baileys-panel-base');
            const savedToken = localStorage.getItem('baileys-panel-token');
            if (savedBase) serverInput.value = savedBase;
            if (savedToken) tokenInput.value = savedToken;
          } catch (error) {
            console.warn('Não foi possível carregar configurações salvas:', error);
          }
        }

        function persistSettings() {
          try {
            localStorage.setItem('baileys-panel-base', serverInput.value.trim());
            localStorage.setItem('baileys-panel-token', tokenInput.value.trim());
          } catch (error) {
            console.warn('Não foi possível salvar configurações:', error);
          }
        }

        function getBaseUrl() {
          return serverInput.value.trim();
        }

        function normalizePath(path) {
          if (!path.startsWith('/')) {
            return `/${path}`;
          }
          return path;
        }

        function buildUrl(path) {
          const base = getBaseUrl();
          const normalizedPath = normalizePath(path);
          if (!base) {
            return normalizedPath;
          }
          const sanitizedBase = base.endsWith('/') ? base.slice(0, -1) : base;
          return `${sanitizedBase}${normalizedPath}`;
        }

        function buildHeaders(hasBody) {
          const headers = { Accept: 'application/json' };
          if (hasBody) {
            headers['Content-Type'] = 'application/json';
          }
          const token = tokenInput.value.trim();
          if (token) {
            headers.Authorization = token.toLowerCase().startsWith('bearer ') ? token : `Bearer ${token}`;
          }
          return headers;
        }

        async function apiFetch(path, { method = 'GET', body } = {}) {
          const hasBody = body !== undefined;
          const response = await fetch(buildUrl(path), {
            method,
            headers: buildHeaders(hasBody),
            body: hasBody ? JSON.stringify(body) : undefined,
          });
          const text = await response.text();
          let data = null;
          if (text) {
            try {
              data = JSON.parse(text);
            } catch (error) {
              data = text;
            }
          }
          return { response, data };
        }

        function setFormFeedback(message, type = 'info') {
          formFeedback.textContent = message || '';
          formFeedback.classList.remove('error', 'success');
          if (!message) return;
          if (type === 'error') {
            formFeedback.classList.add('error');
          } else if (type === 'success') {
            formFeedback.classList.add('success');
          }
        }

        function setInstancesFeedback(message, type = 'info') {
          instancesFeedback.textContent = message || '';
          instancesFeedback.classList.remove('error', 'success');
          if (!message) return;
          if (type === 'error') {
            instancesFeedback.classList.add('error');
          } else if (type === 'success') {
            instancesFeedback.classList.add('success');
          }
        }

        function stopQrPolling(instanceId) {
          const entry = state.polling.get(instanceId);
          if (!entry) return;
          if (entry.refreshTimer) {
            clearTimeout(entry.refreshTimer);
          }
          if (entry.countdownTimer) {
            clearInterval(entry.countdownTimer);
          }
          state.polling.delete(instanceId);
        }

        function stopAllPolling() {
          state.polling.forEach((_, instanceId) => stopQrPolling(instanceId));
        }

        function getDisplayUrl(path) {
          const url = buildUrl(path);
          if (getBaseUrl()) {
            return url;
          }
          const origin = window.location.origin;
          return `${origin}${url}`;
        }

        function buildEndpointBlocks(instance) {
          const encodedId = encodeURIComponent(instance.id);
          return [
            {
              method: 'GET',
              path: `/qrcode?instanceId=${encodedId}`,
              description: 'Recupera o QR Code atual da instância para autenticação.',
            },
            {
              method: 'GET',
              path: `/instances/${encodedId}`,
              description: 'Obtém os detalhes e metadados cadastrados da instância.',
            },
            {
              method: 'PATCH',
              path: `/instances/${encodedId}/status`,
              description: 'Atualiza manualmente o status armazenado da instância.',
              example: {
                status: 'disconnected',
              },
            },
            {
              method: 'DELETE',
              path: `/instances/${encodedId}`,
              description: 'Desconecta e remove a instância, incluindo a sessão salva.',
            },
            {
              method: 'POST',
              path: '/messages',
              description: 'Envia uma mensagem via Baileys utilizando esta instância.',
              example: {
                instanceId: instance.id,
                to: '5511999999999',
                type: 'text',
                message: {
                  text: 'Olá! Esta é uma mensagem enviada pela instância.'
                }
              },
            },
          ];
        }

        function renderEndpoints(container, instance) {
          const endpoints = buildEndpointBlocks(instance);
          const wrapper = document.createElement('div');
          wrapper.className = 'endpoints-grid';

          endpoints.forEach((endpoint) => {
            const card = document.createElement('article');
            card.className = 'endpoint-card';

            const header = document.createElement('div');
            header.className = 'endpoint-header';

            const methodBadge = document.createElement('span');
            methodBadge.className = `method-badge method-${endpoint.method.toLowerCase()}`;
            methodBadge.textContent = endpoint.method;

            const pathLabel = document.createElement('code');
            pathLabel.textContent = getDisplayUrl(endpoint.path);

            header.appendChild(methodBadge);
            header.appendChild(pathLabel);
            card.appendChild(header);

            if (endpoint.description) {
              const description = document.createElement('p');
              description.className = 'hint';
              description.textContent = endpoint.description;
              card.appendChild(description);
            }

            if (endpoint.example) {
              const pre = document.createElement('pre');
              pre.textContent = JSON.stringify(endpoint.example, null, 2);
              card.appendChild(pre);
            }

            wrapper.appendChild(card);
          });

          container.innerHTML = '';
          container.appendChild(wrapper);
        }

        function isProbablyBase64(value) {
          if (typeof value !== 'string') return false;
          const sanitized = value.trim();
          if (!sanitized) return false;
          const base64Pattern = /^[A-Za-z0-9+/=\s]+$/;
          return sanitized.length % 4 === 0 && base64Pattern.test(sanitized);
        }

        async function ensureDataUrl(value, typeHint = 'image/png') {
          if (!value || typeof value !== 'string') {
            return null;
          }

          const trimmed = value.trim();
          if (!trimmed) {
            return null;
          }

          if (trimmed.startsWith('data:image/')) {
            return trimmed;
          }

          if (/^https?:\/\//i.test(trimmed)) {
            return trimmed;
          }

          if (isProbablyBase64(trimmed)) {
            return `data:${typeHint};base64,${trimmed}`;
          }

          if (window.QRCode && typeof window.QRCode.toDataURL === 'function') {
            try {
              return await new Promise((resolve, reject) => {
                window.QRCode.toDataURL(
                  trimmed,
                  {
                    errorCorrectionLevel: 'M',
                    margin: 2,
                  },
                  (error, url) => {
                    if (error) {
                      reject(error);
                    } else {
                      resolve(url);
                    }
                  }
                );
              });
            } catch (error) {
              console.warn('Falha ao converter QR code em data URL:', error);
            }
          }

          return null;
        }

        async function resolveQrImageSource(payload) {
          if (!payload) {
            return null;
          }

          if (typeof payload === 'string') {
            return ensureDataUrl(payload);
          }

          if (payload.image) {
            if (typeof payload.image === 'string') {
              const direct = await ensureDataUrl(payload.image);
              if (direct) return direct;
            } else if (typeof payload.image === 'object') {
              if (payload.image.value) {
                const type = (payload.image.type || 'image/png').toLowerCase();
                if (type === 'data-url') {
                  const resolved = await ensureDataUrl(payload.image.value);
                  if (resolved) return resolved;
                } else {
                  const mimeType = type === 'base64' ? 'image/png' : type;
                  const resolved = await ensureDataUrl(payload.image.value, mimeType);
                  if (resolved) return resolved;
                }
              }
              if (payload.image.data) {
                const resolved = await ensureDataUrl(payload.image.data);
                if (resolved) return resolved;
              }
            }
          }

          const candidates = [payload.code, payload.qr, payload.value];
          for (const candidate of candidates) {
            if (!candidate) continue;
            if (typeof candidate === 'string') {
              const resolved = await ensureDataUrl(candidate);
              if (resolved) return resolved;
            } else if (typeof candidate === 'object' && candidate.value) {
              const resolved = await ensureDataUrl(candidate.value);
              if (resolved) return resolved;
            }
          }

          return null;
        }

        function extractExpiresIn(payload) {
          if (!payload || typeof payload !== 'object') {
            return null;
          }
          if (typeof payload.expiresIn === 'number') {
            return payload.expiresIn;
          }
          if (payload.image && typeof payload.image === 'object' && typeof payload.image.expiresIn === 'number') {
            return payload.image.expiresIn;
          }
          if (payload.code && typeof payload.code === 'object' && typeof payload.code.expiresIn === 'number') {
            return payload.code.expiresIn;
          }
          return null;
        }

        function renderInstances() {
          stopAllPolling();
          instanceList.innerHTML = '';

          if (!state.instances.length) {
            emptyState.classList.remove('hidden');
            return;
          }

          emptyState.classList.add('hidden');

          state.instances.forEach((instance) => {
            const card = document.createElement('article');
            card.className = 'instance-card';
            card.dataset.instanceId = instance.id;

            const header = document.createElement('div');
            header.className = 'instance-header';

            const title = document.createElement('div');
            title.className = 'instance-title';
            const displayName =
              instance?.metadata?.campaignName || instance?.metadata?.name || instance?.metadata?.displayName || instance.id;
            title.textContent = displayName;

            const statusBadge = document.createElement('span');
            const statusKey = instance.status && STATUS_LABELS[instance.status] ? instance.status : 'pending_qr';
            statusBadge.className = `status-badge status-${statusKey}`;
            statusBadge.textContent = STATUS_LABELS[statusKey] || instance.status || 'Desconhecido';

            header.appendChild(title);
            header.appendChild(statusBadge);

            const meta = document.createElement('div');
            meta.className = 'instance-meta';
            const idRow = document.createElement('span');
            const idLabel = document.createElement('strong');
            idLabel.textContent = 'ID: ';
            idRow.appendChild(idLabel);
            idRow.append(instance.id);
            meta.appendChild(idRow);
            if (instance?.metadata && Object.keys(instance.metadata).length) {
              const metadataRow = document.createElement('span');
              const metadataLabel = document.createElement('strong');
              metadataLabel.textContent = 'Metadados: ';
              metadataRow.appendChild(metadataLabel);
              metadataRow.append(JSON.stringify(instance.metadata));
              meta.appendChild(metadataRow);
            }

            const actions = document.createElement('div');
            actions.className = 'instance-actions';

            const qrButton = document.createElement('button');
            qrButton.type = 'button';
            qrButton.className = 'secondary';
            qrButton.dataset.action = 'toggle-qr';
            qrButton.textContent = 'Exibir QR Code';

            const endpointsButton = document.createElement('button');
            endpointsButton.type = 'button';
            endpointsButton.dataset.action = 'toggle-endpoints';
            endpointsButton.textContent = 'Endpoints';

            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'danger';
            deleteButton.dataset.action = 'delete-instance';
            deleteButton.textContent = 'Desconectar';

            actions.append(qrButton, endpointsButton, deleteButton);

            const qrContainer = document.createElement('div');
            qrContainer.className = 'qr-container hidden';
            qrContainer.dataset.role = 'qr-container';

            const qrStatus = document.createElement('p');
            qrStatus.className = 'qr-status';
            qrStatus.dataset.role = 'qr-status';
            qrStatus.textContent = 'Clique em "Exibir QR Code" para gerar o código.';

            const qrImage = document.createElement('img');
            qrImage.className = 'qr-image hidden';
            qrImage.dataset.role = 'qr-image';
            qrImage.alt = `QR Code da instância ${instance.id}`;

            qrContainer.append(qrStatus, qrImage);

            const endpointsContainer = document.createElement('div');
            endpointsContainer.className = 'endpoints-container hidden';
            endpointsContainer.dataset.role = 'endpoints';
            renderEndpoints(endpointsContainer, instance);

            card.append(header, meta, actions, qrContainer, endpointsContainer);
            instanceList.appendChild(card);
          });
        }

        async function loadInstances() {
          setInstancesFeedback('Carregando instâncias...');
          try {
            const { response, data } = await apiFetch('/instances');
            if (!response.ok) {
              throw new Error((data && data.message) || 'Não foi possível carregar as instâncias.');
            }
            const instances = Array.isArray(data)
              ? data
              : Array.isArray(data?.instances)
              ? data.instances
              : [];
            state.instances = instances;
            renderInstances();
            setInstancesFeedback(`Instâncias atualizadas em ${new Date().toLocaleTimeString()}.`, 'success');
          } catch (error) {
            console.error(error);
            setInstancesFeedback(error.message || 'Erro inesperado ao carregar instâncias.', 'error');
            instanceList.innerHTML = '';
            emptyState.classList.add('hidden');
          }
        }

        async function handleCreateInstance(event) {
          event.preventDefault();
          persistSettings();
          setFormFeedback('Criando instância...');
          const submitButton = form.querySelector('button[type="submit"]');
          submitButton.disabled = true;

          const id = instanceIdInput.value.trim();
          const campaignName = campaignInput.value.trim();

          const payload = {
            id,
            metadata: campaignName ? { campaignName } : {},
          };

          try {
            const { response, data } = await apiFetch('/instances', { method: 'POST', body: payload });
            if (!response.ok) {
              throw new Error((data && data.message) || 'Falha ao criar a instância.');
            }
            setFormFeedback('Instância criada com sucesso. Consulte o QR Code para autenticar.', 'success');
            form.reset();
            instanceIdInput.focus();
            await loadInstances();
          } catch (error) {
            console.error(error);
            setFormFeedback(error.message || 'Erro inesperado ao criar instância.', 'error');
          } finally {
            submitButton.disabled = false;
          }
        }

        async function handleDeleteInstance(instanceId) {
          if (!confirm('Deseja desconectar e remover esta instância?')) {
            return;
          }
          try {
            const { response, data } = await apiFetch(`/instances/${encodeURIComponent(instanceId)}`, {
              method: 'DELETE',
            });
            if (!response.ok) {
              throw new Error((data && data.message) || 'Falha ao desconectar a instância.');
            }
            stopQrPolling(instanceId);
            await loadInstances();
          } catch (error) {
            console.error(error);
            setInstancesFeedback(error.message || 'Erro ao desconectar instância.', 'error');
          }
        }

        function toggleEndpoints(card) {
          const container = card.querySelector('[data-role="endpoints"]');
          container.classList.toggle('hidden');
        }

        function toggleQr(card) {
          const instanceId = card.dataset.instanceId;
          const container = card.querySelector('[data-role="qr-container"]');
          const button = card.querySelector('button[data-action="toggle-qr"]');
          const qrStatus = card.querySelector('[data-role="qr-status"]');
          const qrImage = card.querySelector('[data-role="qr-image"]');
          const isVisible = !container.classList.contains('hidden');

          if (isVisible) {
            container.classList.add('hidden');
            button.textContent = 'Exibir QR Code';
            qrImage.classList.add('hidden');
            qrImage.removeAttribute('src');
            qrStatus.textContent = 'Clique em "Exibir QR Code" para gerar o código.';
            stopQrPolling(instanceId);
            return;
          }

          container.classList.remove('hidden');
          button.textContent = 'Ocultar QR Code';
          startQrPolling(instanceId, card);
        }

        function startQrPolling(instanceId, card) {
          stopQrPolling(instanceId);

          const qrStatus = card.querySelector('[data-role="qr-status"]');
          const qrImage = card.querySelector('[data-role="qr-image"]');

          const entry = {
            refreshTimer: null,
            countdownTimer: null,
            fetching: false,
          };

          function updateCountdown(expiresIn) {
            if (!Number.isFinite(expiresIn) || expiresIn <= 0) {
              return;
            }

            if (entry.countdownTimer) {
              clearInterval(entry.countdownTimer);
            }

            let remaining = Math.max(0, Math.floor(expiresIn));

            const renderRemaining = () => {
              if (!state.polling.has(instanceId)) {
                return;
              }

              if (remaining <= 0) {
                qrStatus.textContent = 'QR Code expirou. Gerando um novo...';
                clearInterval(entry.countdownTimer);
                entry.countdownTimer = null;
                return;
              }

              const plural = remaining === 1 ? '' : 's';
              qrStatus.textContent = `Escaneie o QR Code pelo WhatsApp. Expira em ${remaining} segundo${plural}.`;
            };

            renderRemaining();

            entry.countdownTimer = setInterval(() => {
              remaining -= 1;
              renderRemaining();
            }, 1000);
          }

          function scheduleNextFetch(delayMs) {
            if (entry.refreshTimer) {
              clearTimeout(entry.refreshTimer);
            }

            entry.refreshTimer = setTimeout(() => {
              entry.refreshTimer = null;
              fetchQr('refresh');
            }, Math.max(2000, delayMs));
          }

          async function fetchQr(reason = 'initial') {
            if (!state.polling.has(instanceId)) {
              return;
            }

            if (entry.fetching) {
              return;
            }

            entry.fetching = true;

            if (!qrImage.src) {
              qrImage.classList.add('hidden');
            }

            if (entry.countdownTimer) {
              clearInterval(entry.countdownTimer);
              entry.countdownTimer = null;
            }

            qrStatus.textContent = reason === 'refresh' ? 'Atualizando QR Code...' : 'Buscando QR Code...';

            try {
              const { response, data } = await apiFetch(`/qrcode?instanceId=${encodeURIComponent(instanceId)}`);
              if (response.ok) {
                const imageSrc = await resolveQrImageSource(data);
                if (imageSrc) {
                  qrImage.src = imageSrc;
                  qrImage.classList.remove('hidden');
fix-qr-code-scanning-failure-hury0x

                  const expiresIn = extractExpiresIn(data);
                  if (typeof expiresIn === 'number' && expiresIn > 0) {
                    updateCountdown(expiresIn);
                    const nextDelay = (expiresIn - 3) * 1000;
                    scheduleNextFetch(Number.isFinite(nextDelay) ? nextDelay : 7000);
                  } else {
                    qrStatus.textContent = 'Escaneie o QR Code pelo WhatsApp.';
                    scheduleNextFetch(7000);
                  }
                  return;
                }

                console.warn('Resposta da API não contém imagem de QR Code reconhecida:', data);

              }

              const message =
                typeof data === 'string'
                  ? data
                  : data?.message || 'QR Code não disponível no momento.';
              qrStatus.textContent = message;
              qrImage.classList.add('hidden');
              qrImage.removeAttribute('src');

              if (response.status === 404 && data?.code === 'qr_not_available') {
                stopQrPolling(instanceId);
                return;
              }

              scheduleNextFetch(7000);
            } catch (error) {
              console.error(error);
              qrStatus.textContent = 'Erro ao consultar o QR Code.';
              qrImage.classList.add('hidden');
              qrImage.removeAttribute('src');
              scheduleNextFetch(7000);
            } finally {
              entry.fetching = false;
            }
          }

          state.polling.set(instanceId, entry);
          fetchQr('initial');
        }

        instanceList.addEventListener('click', (event) => {
          const button = event.target.closest('button[data-action]');
          if (!button) return;
          const card = button.closest('.instance-card');
          if (!card) return;
          const instanceId = card.dataset.instanceId;

          switch (button.dataset.action) {
            case 'toggle-qr':
              toggleQr(card);
              break;
            case 'toggle-endpoints':
              toggleEndpoints(card);
              break;
            case 'delete-instance':
              handleDeleteInstance(instanceId);
              break;
            default:
              break;
          }
        });

        form.addEventListener('submit', handleCreateInstance);
        refreshButton.addEventListener('click', loadInstances);
        const handleServerChange = () => {
          persistSettings();
          renderInstances();
        };

        serverInput.addEventListener('change', handleServerChange);
        serverInput.addEventListener('blur', handleServerChange);
        tokenInput.addEventListener('change', persistSettings);
        tokenInput.addEventListener('blur', persistSettings);

        loadSettings();
        loadInstances();
      })();
    </script>
  </body>
</html>
